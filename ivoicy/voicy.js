var msg;var loadMessage;var prefs=new gadgets.Prefs();var debugMode=false;var myID;var theHost;var myRamdom="";var iCanListen=false;var tabs;var iamTheHost=false;var IamRecording=false;var particiPready=false;var iframeWin;var waitingForCharlau=true;var runPerd;var waitwave;var isbugged=true;var xmess;var spMessage="";function init(){msg=new gadgets.MiniMessage();if(isbugged){waitwave=msg.createStaticMessage("loading gadget");runPerd=setInterval(waitingWave,500)}else{loadMessage=msg.createStaticMessage("loading gadget");if(wave&&wave.isInWaveContainer()){wave.setStateCallback(stateUpdated);wave.setParticipantCallback(participantIsReady)}}}function init2Old(){var a=prefs.getString("zfile");if(a==null||a.length==0||a==false){if(!getST("zfile")){setST("zfile",randomString(15)+".txt")}}else{setST("zfile",a);prefs.set("zfile","")}if(prefs.getBool("priva")==true){setST("priva",true)}else{if(!getST("priva")){setST("priva",false)}}setST("usingStates",true)}function init2(){if(!getST("zfile")){setST("zfile",randomString(15)+".txt")}}function waitingWave(){try{if((wave)&&wave.isInWaveContainer()){clearInterval(runPerd);msg.dismissMessage(waitwave);loadMessage=msg.createStaticMessage("loading gadget");wave.setStateCallback(stateUpdated);wave.setParticipantCallback(participantIsReady)}}catch(a){loGit("waitingWave error:"+a)}}function stateUpdated(){document.getElementById("player_container").innerHTML="";if(iCanListen&&!waitingForCharlau){iframeWin.postMessage("[getlist]~~om~~"+getST("zfile")+"~~om~~~~om~~~~om~~","http://www.charlau.com")}}function participantIsReady(){if(!particiPready&&wave.getViewer()){myID=wave.getViewer().getId();theHost=wave.getHost().getId();getReady();document.getElementById("mainIframe").src="http://www.charlau.com/gwave/voicy/comm-google-charlau.html";iframeWin=document.getElementById("mainIframe").contentWindow;window.addEventListener("message",receiver,false);particiPready=true;runPerd=setInterval(pingCharlau,500)}}function getST(c){var b;try{b=wave.getState().get(c)}catch(a){loGit("getST error: "+c+" --> "+a)}if(b==null||b.length==0||b=="false"){b=false}if(b=="true"){b=true}return b}function setST(b,c){var d=c.toString();try{wave.getState().submitValue(b,d)}catch(a){loGit("setST error: "+b+", "+d+" "+typeof(d)+" --> "+a)}}function pingCharlau(){iframeWin.postMessage("[ping]~~om~~","http://www.charlau.com")}function getReady(){if(getST("usingStates")){init2()}else{init2Old()}if(myID==theHost){iamTheHost=true;document.getElementById("playdiv").style.display="block";document.getElementById("mprivates").style.display="block";setOpt()}else{document.getElementById("HostOpt").style.marginTop="105px"}var d;var b="";tabs=new gadgets.TabSet("voicy");tabs.alignTabs("left",10);if(iamTheHost||!(prefs.getBool("priva")||getST("priva"))){iCanListen=true;tabs.addTab("Play messages",{contentContainer:document.getElementById("playdiv"),callback:toPlayTab,index:0});d="Note: this recording is not anonymous - your name will appear on the list with your message"}else{d="Note: your id will appear with your message only for the owner of the wave";IamRecording=true;document.getElementById("playdiv").innerHTML="";b='<div id="byline" style="font-family: Courier, \'Courier New\', arial, sans-serif; font-size:10px; float:left; width:100%; margin-top:10px; margin-bottom:1px; margin-left:10px; padding:0; line-height:14px;"><a href="https://wave.google.com/wave/?#minimized:search,restored:wave:googlewave.com!w%252BhsKZwB2sI" target="_blank">feedback wave</a><br />Gadget by <a href="http://charlau.posterous.com/" target="_blank">charlau</a></div>'}var c=tabs.addTab("Leave a message",{callback:toRecTab,index:1});var a='<div id="rectab" style="font-family:courier, arial, sans-serif; font-size:10px; margin-left:8px; margin-top:3px; margin-right:10px; margin-bottom:10px; float:right;"> </div><div style="font-family:verdana, arial, sans-serif; font-style:italic; padding-top:3px; padding-left:10px; padding-right:10px;">'+d+'</div><div id="recorder_container" style="float:left; width:100%; display:block; margin-left:10px; height:160px;"></div>'+b;document.getElementById(c).innerHTML=a;rifflyShowRecorder("recorder_container","audio","rifflyFinishedRecording");gadgets.window.adjustHeight()}function receiver(b){Connected=true;if(b.origin=="http://www.charlau.com"){clearInterval(runPerd);var a=b.data.split("~~om~~");if(iCanListen){switch(a[0]){case"[ping]":waitingForCharlau=false;msg.dismissMessage(loadMessage);loadMessage=msg.createStaticMessage("loading message list");iframeWin.postMessage("[getlist]~~om~~"+getST("zfile")+"~~om~~~~om~~~~om~~","http://www.charlau.com");break;case"[addrec]":myRamdom=randomString(10);wave.getState().submitDelta({added:myRamdom});msg.createTimerMessage("Message sent!",2);break;case"[getlist]":if(a[1]=="BAD"){msg.dismissMessage(loadMessage);msg.createTimerMessage("No messages yet...<br />why don't you add one? :)",3)}else{generateList(a)}break;default:}}else{switch(a[0]){case"[ping]":waitingForCharlau=false;msg.dismissMessage(loadMessage);break;case"[addrec]":msg.createTimerMessage("Message sent!!",2);myRamdom=randomString(10);wave.getState().submitDelta({added:myRamdom});break;default:}}}}function generateList(e){var c;var b;var a;msg.dismissMessage(loadMessage);loadMessage=msg.createStaticMessage("loading message list");document.getElementById("player_container").innerHTML="";document.getElementById("choosefile").style.display="none";document.toplay.riffly_id2.options.length=0;document.toplay.riffly_id2.options[0]=new Option("-------click to play-------","",true,true);for(x=1;x<e.length-1;x++){c=e[x].split("|||");try{b=wave.getParticipantById(c[0]).getDisplayName()}catch(d){loGit(d);b="unknown user"}document.toplay.riffly_id2.options[x]=new Option(b,c[1],false,false)}if(!IamRecording){tabs.setSelectedTab(0)}msg.dismissMessage(loadMessage);document.getElementById("choosefile").style.display="block";if(!getST("nbmessages")){setST("nbmessages",(e.length-2).toString())}else{a=(e.length-2)-parseInt(getST("nbmessages"));if((iamTheHost)&&(a>0)){msg.createDismissibleMessage("You have "+a.toString()+" new message(s)");setST("nbmessages",(e.length-2).toString())}}document.getElementById("xxmessages").innerHTML="&nbsp;"+(e.length-2).toString()+"&nbsp;"}function checkOpt(a){if(myID==theHost){if(a.checked){setST("priva",true)}else{setST("priva",false)}}}function setOpt(){var a;if(myID==theHost){a=document.getElementsByTagName("form")[1];if(!getST("usingStates")){setST("priva",prefs.getBool("priva"));setST("usingStates",true)}a.priva.checked=(getST("priva"))}}function rifflyFinishedRecording(a,b){iframeWin.postMessage("[addrec]~~om~~"+getST("zfile")+"~~om~~"+myID+"~~om~~"+a+"~~om~~","http://www.charlau.com");if(iCanListen){IamRecording=false}else{rifflyShowRecorder("recorder_container","audio","rifflyFinishedRecording")}}function showPlayer(b,c,d){var a=document.getElementById(b);if(!waitingForCharlau){msg.createTimerMessage("Loading recorded message",2);if(d=="video"){}else{if(d=="audio"){document.getElementById("player_container").innerHTML='<embed id="riffyplayerx" src="http://riffly.com/p/'+c+'" width="190" height="20" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="false"></embed>';a.style.display="block"}}}}function toPlayTab(a){IamRecording=false;document.toplay.riffly_id2.selectedIndex=0;document.getElementById("player_container").innerHTML=""}function toRecTab(a){IamRecording=true}function randomString(d){var c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";var a="";var b;for(x=0;x<d;x++){b=Math.floor(Math.random()*62);a+=c.charAt(b)}return a}function loGit(a){if(debugMode){msg.createDismissibleMessage("*** "+a+" ***")}}function rifflyShowRecorder(a,c,d){var b=document.getElementById(a);b.style.display="block";if(c=="audio"){b.innerHTML='<embed id="riffly_recorder_object" src="http://riffly.com/static/flash/rifflyrecorder.swf" quality="high" bgcolor="#ffffff" name="riffly_recorder_object" allowscriptaccess="always" scale="noscale" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" align="middle" width="320" height="138" flashvars="callback='+encodeURIComponent(d)+"&mode=audio&url="+encodeURIComponent(location.href)+"&post_title="+encodeURIComponent(document.title)+'"></embed>'}else{b.innerHTML='<embed id="riffly_recorder_object" src="http://riffly.com/static/flash/rifflyrecorder.swf" quality="high" bgcolor="#ffffff" name="riffly_recorder_object" allowscriptaccess="always" scale="noscale" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" align="middle" width="320" height="260" flashvars="callback='+encodeURIComponent(d)+"&mode=video&url="+encodeURIComponent(location.href)+"&post_title="+encodeURIComponent(document.title)+'"></embed>'}}gadgets.util.registerOnLoadHandler(init);